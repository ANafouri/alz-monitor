# Monitoring and Alerting in ALZ

[TOC]

## ALZ Monitor Alert Approach

The overall approach for enabling alerts in ALZ is to use Azure Policy to deploy relevant alerts as resources are created, configure action group(s), and then use Alert Processing Rules to activate alerts and connect them to the Action Group.

There are two general principles/approaches to enabling alerting in ALZ:

- Centralized
- Decentralized

These options would need to be paramaterized in the reference implementations (Portal Accelerator, ALZ-Terraform and ALZ-Bicep).

### Centralized

The key distinction for a centralized approach is that there is a central Action Group that is used for all alerts, which means a single alerting email (distribution group) address.

Metric alerts are deployed with resources (same resource group). Platform alerts like Service Health / Activity are created in a dedicated resource group, typically in the management platform landing zone. A single Alert Action Group in the management landing zone configured with a central alerting email address, and Alert Processing Rules enabling filters and connecting alerts to the Action Group.

### Decentralized

For a decentralized approach is that every subscription has a dedicated Action Group allowing for more granular control of how to direct alert notifications, for example, for connectivity/networking alerts for the platform connectivity subscription, direct the alerts to the network operations team.

While enabling this for ALZ native created landing zones, there is considerable complexity in handling this for Landing Zones. Perhaps we should pin supporting workload landing zones to MVP2.

Metric alerts are deployed with resources (in the same resource group). Platform alerts like Service Health / Activity are created in a dedicated resource group, typically in the management platform landing zone. Alert Action Groups are created in each landing zone subsccription, allowing each operational area and landing zone subscription to have different alerting email addresses (networking, identity, ops, workloads, etc.). Alert Processing Rules are created to enable filters and connect alerts to the Action Groups.

## ALZ Monitor Alert Policy Definitions

The following poicy definition categories will be enabled as part of ALZ deployments:

- Resource Metrics
- Service and Resource Health
- Activity Logs
- Log Alerts (from Log Analytics) - TBD

### Deployment

ALZ Alerts are deployed using Azure Policy. This work is largely done, just working on the conversion from Bicep to ARM JSON so they can be incorporated into the Enterprise-Scale repo.

#### Resource Metrics

Alerts are configured to be deployed in the same resource group as the create Azure resource.

##### Service and Resource Health

[Service health](https://learn.microsoft.com/en-us/azure/service-health/overview) provides a personalized view of the health of the Azure services and regions you're using. Resource health provides information about the health of your individual cloud resources such as a specific virtual machine instance.

Service and resource health events are written into the activity log. This means we can create a sub set of activity log alerts that can alert to the health events. As with all activity log alerts these will be raised as severity 4 alerts. We create these alerts scoped to each subscription. Four separate alerts for the four service health categories of Incident, Planned Maintenance, Security Advisories and Health Advisories.
A resource health alerts will be created for any resource that goes into an unavailable or degraded state and that can be platform or user initiated. We will ignore if the state is unknown as this can lead to erroneous alerting.

For activity log alerts will be looking for any delete activity log events for the following resources within the subscriptions: Key vault, Log Analytics workspaces, Azure Firewall and Network Security Groups

##### DNS Zone Alerts

1. RecordSetCapacityUtilization alert
1. RecordSetCount alert
1. QueryVolume alert

#### All Others

Alerts are configured to be deployed deployed in a dedicated resource group: AlzMonitoring-rg.

## ALZ Monitor Alert Action Groups

Alert Action Groups define the action to take when an alert is associated with it. For ALZ we will limit this action to sending an email to a provided email (distribution group) address.

[ALZ Monitor Alert Approach](https://github.com/Azure/alz-monitor/wiki/alertapproach.md) defines two approaches to implementing Action Groups.

### Deployment Mechanism

Azure Policy : more consistent with overall ALZ approach and much simpler to maintain as it would be managed from the Enterprise-Scale repository (along with all the alert policies). Additionally, using policy enables the automatic creation of an Action Group when the subscription is created.

### Action Groups

Action Groups provide the action capability (what to do with the alert) when an alert is fired. For ALZ we will default to using a provided email address to send the alert details to.

There are two patterns for consideration on how to deploy Action Groups in ALZ as follows:

#### Centralized Action Group

A single centralized action group in the "AlzMonitoring-RG" resource group in the management platform landing zone. This is a simpler approach and only supports a single email (distribution group) address for all alert forwarding. This is perceived as being too limited for most scenarios.

Policy Scope: Single subscription

#### Decentralized Action Group

An action group in the "AlzMonitoring-RG" resource group in each subscription. This approach is best configured through policy, however, need to validate how to configure email (distribution group) address for alert forwarding.  A single email address could be used across each deployed subscriptions action group, or allows the configuration of different email addresses per subscription/workload/infrastructure area.  The action groups will be triggered through Alert Processing Rules that can only be scoped to subscription at the highest level so would fit into this pattern.

Policy Scope: Management Group/Subscription

#### ALZ Decision

The decision is to follow the decentralized approach and provision a single Action Group per subscription. This allows customers to configure discrete actions per subscription (different email addresses or other supported actions).

Alert Processing Rules will target the Action Group in the subscription where the alert originated.

The initial configuration provided by ALZ will configure all Action Groups with the same email distribution group/address through Azure Policy. Customers may choose to configure alternate email distribution groups depending on the subscription/service or workload owners/etc.

## ALZ Monitor Alert Processing Rules

Alert Processing Rules enables the filtering of alerts and direct alerts to approriate action groups based on filter criteria.

For ALZ we will implement a single Action Group per subscription, and initially deploy a single Alert Processing Rule without filters to action alerts via the Action Group.

Suggest a review of minimum filters for the Alert Processing Rule for optimal alert processing.

Available filters:
- Alert condition
- Alert context (payload)
- Alert rule id
- Alert name
- Description
- Monitor service
- Resource
- Resource group
- Resource type
- Severity
- Signal type

As an example suggest Severity (Critical, Error, Warning) only, filtering out (Informational, Verbose).